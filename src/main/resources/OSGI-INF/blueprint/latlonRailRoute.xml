<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">



  
    <!-- Imported OSGi services include the Transaction manager and JDBC DataSource -->
  <!-- 
    <reference id="LatLon-db" interface="javax.sql.DataSource" availability="mandatory" filter="(datasource.name=SQL_Src_LL)"/> 
    <reference id="BSM-db" interface="javax.sql.DataSource" availability="mandatory" filter="(datasource.name=SQL_Tgt_LL)"/>   
	 --> 

<!--*************** this is the JDBC data sources for development test ******************************************************-->
 
<bean id="LatLon-db" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
  <property name="driverClassName" value="com.microsoft.sqlserver.jdbc.SQLServerDriver"/>
  <property name="url" value="jdbc:sqlserver://10.10.110.123\mssqlserver2012;databaseName=main_test2"/>
  <property name="username" value="devsa"/>
  <property name="password" value="Magma1"/>
</bean>



<!--*************** this is the JDBC data source for development test *******************************************************-->

  
<!-- configure the Camel SQL component to use the JDBC data source -->
<bean id="sqlSrc" class="org.apache.camel.component.sql.SqlComponent">
  <property name="dataSource" ref="LatLon-db"/>
</bean>




<bean id="dataProcessor" class="bsm.prototype.database.latlon.DataProcessor"/>

<!--*************** this is the JMS data source for AMQ *******************************************************-->

<bean id="jmsConnectionFactory" 
   class="org.apache.activemq.ActiveMQConnectionFactory">
   <property name="brokerURL" value="tcp://localhost:61616" />
   <property name="userName" value="admin" />
   <property name="password" value="admin" />
</bean>
 
<bean id="pooledConnectionFactory" 
   class="org.apache.activemq.pool.PooledConnectionFactory" init-method="start" destroy-method="stop">
   <property name="maxConnections" value="8" />
   <property name="connectionFactory" ref="jmsConnectionFactory" />
</bean>
 
<bean id="jmsConfig" 
   class="org.apache.camel.component.jms.JmsConfiguration">
   <property name="connectionFactory" ref="pooledConnectionFactory"/>
   <property name="concurrentConsumers" value="10"/>
</bean>
 
<bean id="activemq" 
    class="org.apache.activemq.camel.component.ActiveMQComponent">
    <property name="configuration" ref="jmsConfig"/>
</bean>



  <camelContext xmlns="http://camel.apache.org/schema/blueprint">
  <propertyPlaceholder location="classpath:sql.properties" id="properties"/>
  <route id="LatLonDbToAMQ">
    <from uri="sqlSrc:{{sql.selectTest}}"/>
    <log message="Start batch" loggingLevel="WARN"/>
    <log message="Message Type is : ${body[MESSAGE_TYPE_ID]}" loggingLevel="INFO"/>
    <multicast>
      <choice>
        <when>
          <simple>${body[LMU_ID]} != null</simple>
          <log message="Sending to AMQ : LMU" loggingLevel="INFO"/>
          <to uri="activemq:queue:LatLonLMUDevice"/>
        </when>
        <when>
          <simple>${body[STU_ID]} != null</simple>
          <log message="Sending to AMQ : STU" loggingLevel="INFO"/>
          <to uri="activemq:queue:LatLonSTUDevice"/>
        </when>
        <otherwise>
          <log message="Generic Message" loggingLevel="INFO"/>
        </otherwise>
      </choice>
      <filter>
        <simple>${body[MESSAGE_TYPE_ID]} == 4</simple>
        <log message="Alarm Message" loggingLevel="INFO"/>
        <to uri="activemq:queue:LatLonAlarm"/>
      </filter>
    </multicast>
  </route>

</camelContext>

</blueprint>
